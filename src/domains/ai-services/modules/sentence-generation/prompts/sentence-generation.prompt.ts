import { GenerateSentenceParams } from '../interfaces/generate-sentence-params.interface';
import { PromptTemplate } from '../interfaces/prompt-template.interface';

export const sentenceGenerationPrompt: PromptTemplate<GenerateSentenceParams> =
  {
    version: '1.30.2',
    template: `Твоя задача — создать образцовую учебную пару предложений (русское и английское) с подсказкой для изучения иностранного языка, строго следуя параметрам и требованиям ниже.

**ПАРАМЕТРЫ ЗАПРОСА**:
- Английское слово: "{{word}}" ({{partOfSpeech}})
- Грамматическая тема: "{{grammarTopic}}"
- Уровень CEFR: {{cefrLevel}}

**ОСНОВНАЯ ЗАДАЧА**:
Сгенерировать комплект из русского предложения, его английского перевода и краткой подсказки, который максимально эффективно поможет изучающему язык уровня {{cefrLevel}} понять и усвоить использование слова "{{word}}" (как {{partOfSpeech}}) в контексте грамматической темы "{{grammarTopic}}".

**ГЛАВНЫЕ ПРИНЦИПЫ ГЕНЕРАЦИИ**:
*   **Естественность и Аутентичность**: Оба предложения должны звучать АБСОЛЮТНО ЕСТЕСТВЕННО, как в повседневной речи носителей языка. Избегай любых искусственных, книжных или неуклюжих конструкций.
*   **Соответствие Уровню {{cefrLevel}}**: СТРОГО придерживайся лексики, грамматики и ДЛИНЫ предложений, указанных в "ОРИЕНТИРЫ ПО СЛОЖНОСТИ" для уровня {{cefrLevel}}. Особенно это касается уровней A0-A2 (предельная простота, базовые слова, короткие предложения).
*   **Фокус на Грамматике и Слове**: Грамматическая тема "{{grammarTopic}}" и слово "{{word}}" (в его {{partOfSpeech}}, а также его русский эквивалент в соответствующей части речи) должны быть ЦЕНТРАЛЬНЫМИ, корректно и ЯВНО продемонстрированными элементами в предложениях. Связь между "{{word}}" и "{{grammarTopic}}" должна быть логичной и осмысленной.
*   **Оригинальность и Полезность**: Каждая пара предложений должна быть УНИКАЛЬНОЙ, интересной и действительно помогать в обучении. Предложения не должны быть скучными или шаблонными.

**ПОШАГОВОЕ РУКОВОДСТВО ПО СОЗДАНИЮ**:
1.  **Анализ и Эквивалент**:
    *   Глубоко проанализируй английское слово "{{word}}" ({{partOfSpeech}}).
    *   Определи наиболее подходящий, САМЫЙ РАСПРОСТРАНЕННЫЙ и семантически точный русский эквивалент, строго соответствующий указанной {{partOfSpeech}} и подходящий для уровня {{cefrLevel}}.
2.  **Русское Предложение**:
    *   Придумай ОРИГИНАЛЬНОЕ русское предложение, которое:
        *   Полностью соответствует "ГЛАВНЫМ ПРИНЦИПАМ ГЕНЕРАЦИИ".
        *   ЯВНО, КОРРЕКТНО и ПРОСТО демонстрирует грамматику "{{grammarTopic}}", используя подобранный русский эквивалент.
        *   Создает узнаваемый контекст или микро-ситуацию.
3.  **Английский Перевод**:
    *   Аккуратно переведи русское предложение на английский, обеспечивая:
        *   Полное соответствие "ГЛАВНЫМ ПРИНЦИПАМ ГЕНЕРАЦИИ".
        *   Использование слова "{{word}}" строго в его {{partOfSpeech}}.
        *   Сохранение смысла, грамматической структуры и стилистическую безупречность для уровня {{cefrLevel}}.
4.  **Подсказка (Translation Tips)**:
    *   Напиши КРАТКУЮ, ЯСНУЮ и ПОЛЕЗНУЮ подсказку на РУССКОМ языке.
    *   Подсказка должна фокусироваться на ключевом аспекте грамматики "{{grammarTopic}}" в данном предложении ИЛИ на интересной особенности перевода/словоупотребления, важной для уровня {{cefrLevel}}.

**ВАРИАТИВНОСТЬ ПРЕДЛОЖЕНИЙ** (придерживайся этих принципов для создания разнообразных и качественных примеров):
-   Типы предложений: Варьируй между утвердительными, отрицательными и вопросительными конструкциями, если это уместно для грамматической темы и уровня.
-   Начало предложений: Старайся начинать предложения с разных членов предложения для разнообразия, если это звучит естественно.
-   Контексты: Используй разнообразные, легко узнаваемые жизненные ситуации (дом, семья, друзья, учеба, хобби, еда, погода, простые действия), особенно для низких уровней.
-   Лексика: Используй синонимы и разнообразные лексические конструкции, соответствующие уровню, чтобы избежать монотонности.
-   Эмоциональная окраска: По возможности, делай предложения позитивными или нейтральными.
-   Наглядность: Пример должен четко иллюстрировать грамматическое правило или функцию слова.

**УРОВЕНЬ {{cefrLevel}} (ОРИЕНТИРЫ ПО СЛОЖНОСТИ)**:
{{#if cefrLevel === "A0"}}
3-5 слов, структура SVO (Подлежащее-Сказуемое-Дополнение), ТОЛЬКО самые базовые слова (люди, предметы, простые действия), только Present Simple Tense, утвердительные предложения.
{{/if}}
{{#if cefrLevel === "A1"}}
4-7 слов, простые структуры, повседневная базовая лексика, Present Simple, Past Simple, Future Simple (will), Present Continuous (простые случаи); модальные глаголы can, may; базовые предлоги места и времени.
{{/if}}
{{#if cefrLevel === "A2"}}
6-9 слов, могут быть простые союзы (and, but, so, because, or), степени сравнения прилагательных, Past Continuous, Present Perfect (основные случаи), to be going to; больше употребительных предлогов и наречий.
{{/if}}
{{#if cefrLevel === "B1"}}
8-12 слов, составные предложения с союзами (although, while, if, unless, when, since), основные модальные глаголы (must, should, might, have to), пассивный залог (простые формы), Past Perfect, Future Continuous, герундий и инфинитив (основные случаи).
{{/if}}
{{#if cefrLevel === "B2"}}
10-15 слов, сложные предложения с различными типами придаточных (relative clauses, reported speech, conditional sentences types 1, 2, 3), более широкий диапазон времен и модальных глаголов, включая перфектные формы инфинитива и герундия, более сложная лексика.
{{/if}}
{{#if cefrLevel === "C1Plus"}}
12-20 слов, сложносочиненные и сложноподчиненные предложения с разнообразными связками, богатая идиоматическая лексика, инверсия, эмфатические конструкции, нюансы грамматики, смешанные условные предложения.
{{/if}}

**КРИТИЧЕСКАЯ САМОПРОВЕРКА (ОБЯЗАТЕЛЬНО ПЕРЕД ВЫДАЧЕЙ!)**:
*   **Естественность (Оба предложения)**: Звучат АБСОЛЮТНО естественно для носителя в повседневной речи?
*   **Уровень {{cefrLevel}} (Оба предложения)**: Строгое соответствие лексике, грамматике, ДЛИНЕ (см. "ОРИЕНТИРЫ")? Особенно для A0-A2.
*   **Русское предложение**:
    *   Явная и корректная демонстрация "{{grammarTopic}}"?
    *   Русский эквивалент слова использован как {{partOfSpeech}}?
    *   Интересное и с понятным контекстом?
*   **Английское предложение**:
    *   Слово "{{word}}" использовано как {{partOfSpeech}}?
    *   Точный и стилистически верный перевод?
*   **Связь "{{word}}" и "{{grammarTopic}}"**: Логична и осмысленна?
*   **Подсказка**: Краткая, полезная, на РУССКОМ, фокусируется на главном для {{cefrLevel}}?
*   **Уникальность**: Не шаблонно? Не повторяет предыдущие успешные генерации?
*   **Общая Цель**: Предложение действительно поможет студенту уровня {{cefrLevel}} понять "{{word}}" и "{{grammarTopic}}"?

**ФОРМАТ ОТВЕТА (СТРОГО ОДИН JSON ОБЪЕКТ)**:
\`\`\`json
{
  "russianTranslation": "Русское предложение, созданное тобой",
  "englishSentence": "Правильный английский перевод",
  "translationTips": "Подсказка на РУССКОМ языке о ключевой грамматике",
  "literalTranslation": "Дословный перевод для понимания структуры (ТОЛЬКО если это действительно полезно для демонстрации грамматической разницы и не вводит в заблуждение)"
}
\`\`\`

**ВАЖНЫЕ НАПОМИНАНИЯ**:
1.  **МНОГОКРАТНАЯ ПРОВЕРКА**: Убедись, что ВСЕ вышеуказанные инструкции и принципы (особенно "Главные Принципы" и "Критическая Самопроверка") тщательно соблюдены.
2.  **JSON ФОРМАТ**: СТРОГО ОДИН валидный JSON-объект. Не массив!
3.  **ОБУЧАЮЩАЯ ЦЕЛЬ**: Помни, главное – создать понятный, корректный и максимально эффективный учебный материал для студента.
`,

    render: (params: GenerateSentenceParams): string => {
      let resultString = sentenceGenerationPrompt.template;

      // Заменяем все плейсхолдеры их значениями
      Object.entries(params).forEach(([key, value]) => {
        resultString = resultString.replace(
          new RegExp(`{{${key}}}`, 'g'),
          String(value),
        );
      });

      // Обрабатываем условные блоки для конкретного уровня CEFR
      const cefrLevel = params.cefrLevel;
      const cefrLevels = ['A0', 'A1', 'A2', 'B1', 'B2', 'C1Plus'];

      cefrLevels.forEach((level) => {
        const ifPattern = new RegExp(
          `{{#if cefrLevel === "${level}"}}([\\s\\S]*?){{/if}}`,
          'g',
        );

        if (level === cefrLevel) {
          // Если это текущий уровень, удаляем теги условия, но оставляем содержимое
          resultString = resultString.replace(ifPattern, (_match, content) => {
            return String(content);
          });
        } else {
          // Если это не текущий уровень, удаляем весь блок
          resultString = resultString.replace(ifPattern, '');
        }
      });

      return resultString;
    },
  };
